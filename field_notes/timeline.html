<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline | Jason Allred</title>
    <link rel="stylesheet" href="style.css?v=4.1">
    <style>
        /* Debug Styles */
        #debug-log {
            background: #220000;
            color: #ffaaaa;
            font-family: monospace;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid red;
            font-size: 0.8rem;
            max-height: 150px;
            overflow-y: auto;
        }
        
        #tree-root {
            border: 1px dashed #444; /* Visibility border */
            min-height: 50px;
        }

        .safe-back {
            display: inline-block;
            background: #333;
            color: white;
            padding: 10px 20px;
            margin-bottom: 20px;
            text-decoration: none;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <button id="menu-toggle">☰</button>

    <nav id="sidebar">
        <h1>The Field Manual</h1>
        <div class="subtitle">Jason Allred</div>
        <div class="sys-banner">GENERATED BY PINKY (MISTRAL-7B)</div>
        <a href="index.html">← Back to Dashboard</a>
        
        <h2>Timeline Index</h2>
        <ul id="timeline-nav"></ul>
    </nav>

    <main>
        <a href="index.html" class="safe-back">← Back to Dashboard (Safe Link)</a>
        
        <div id="debug-log">DEBUG LOG INITIALIZED...</div>

        <section>
            <h2 style="color: var(--heading-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Career Timeline</h2>
            
            <div>[START OF TIMELINE CONTAINER]</div>
            <div class="timeline-container" id="tree-root">
                <!-- Years go here -->
            </div>
            <div>[END OF TIMELINE CONTAINER]</div>

            <div class="terminal-viewer" id="main-terminal">
                <div class="terminal-header">LOG VIEWER</div>
                <div id="terminal-content" style="color: #ccc;">Select a month...</div>
            </div>
        </section>
    </main>

    <script>
        const yearCache = {};
        const debug = document.getElementById('debug-log');
        
        function log(msg) {
            debug.innerHTML += `<div>${new Date().toISOString().split('T')[1].split('.')[0]} ${msg}</div>`;
        }

        window.onerror = function(msg, url, line) {
            log(`[CRITICAL ERROR] ${msg} @ ${line}`);
        };

        document.addEventListener('DOMContentLoaded', () => {
            log("DOM Content Loaded.");
            
            const root = document.getElementById('tree-root');
            const nav = document.getElementById('timeline-nav');
            
            // 1. Mobile Menu
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            if (menuToggle && sidebar) {
                log("Mobile menu elements found.");
                menuToggle.addEventListener('click', (e) => {
                    log("Hamburger clicked.");
                    e.stopPropagation(); // Prevent immediate close
                    sidebar.classList.toggle('active');
                });
                
                // Close when clicking main
                document.querySelector('main').addEventListener('click', () => {
                    sidebar.classList.remove('active');
                });
            } else {
                log("ERROR: Mobile menu elements MISSING in DOM.");
            }

            // 2. Load Data
            log("Fetching themes.json...");
            fetch('data/themes.json?t=' + new Date().getTime())
                .then(r => {
                    if (!r.ok) throw new Error("HTTP " + r.status);
                    return r.json();
                })
                .then(themes => {
                    const keys = Object.keys(themes);
                    log(`Themes loaded. Found ${keys.length} years: ${keys.join(', ')}`);
                    
                    if (keys.length === 0) {
                        root.innerHTML = "<div style='padding:20px; color:yellow;'>Themes.json is empty. Run force_feed.py.</div>";
                        return;
                    }

                    const sortedYears = keys.sort((a, b) => b - a);

                    sortedYears.forEach(year => {
                        const item = themes[year];
                        
                        // Nav Link
                        const li = document.createElement('li');
                        li.innerHTML = `<a href="#year-${year}">${year}</a>`;
                        nav.appendChild(li);

                        // Year Card
                        const yearNode = document.createElement('div');
                        yearNode.className = 'tree-year';
                        yearNode.id = `year-${year}`;
                        
                        yearNode.innerHTML = "
                            <div class=\"year-label\" onclick=\"toggleYear('${year}')\">
                                <span>${year}</span>
                                <span style=\"font-size: 0.8rem; font-weight: normal; color: #888;\">▼</span>
                            </div>
                            <div class=\"year-content\" id=\"content-${year}\">
                                <div class=\"strategy-block\">
                                    <div class=\"strategy-title\">STRATEGIC THEME</div>
                                    ${item.strategic_theme}
                                </div>
                                <ul class=\"file-list\" id=\"files-${year}\">
                                    <li style=\"color: #555;\">Loading...</li>
                                </ul>
                            </div>
                        ";
                        root.appendChild(yearNode);
                    });
                    log("DOM populated with Years.");
                })
                .catch(e => {
                    log(`[FETCH ERROR] ${e.message}`);
                    root.innerHTML = `<div style="color:red;">Failed to load data: ${e.message}</div>`;
                });
        });

        function toggleYear(year) {
            log(`Clicked Year ${year}`);
            const node = document.getElementById(`year-${year}`);
            const fileList = document.getElementById(`files-${year}`);
            
            if (node.classList.contains('open')) {
                node.classList.remove('open');
                return;
            }
            node.classList.add('open');

            if (!yearCache[year]) {
                log(`Fetching data/${year}.json...`);
                fetch(`data/${year}.json?t=${new Date().getTime()}`)
                    .then(r => r.json())
                    .then(events => {
                        log(`Loaded ${events.length} events for ${year}`);
                        yearCache[year] = events;
                        renderFileList(year, events);
                    })
                    .catch(e => {
                        log(`Error loading ${year}: ${e}`);
                        fileList.innerHTML = `<li style="color: #d55;">Log Missing</li>`;
                    });
            } else {
                renderFileList(year, yearCache[year]);
            }
        }

        function renderFileList(year, events) {
            const list = document.getElementById(`files-${year}`);
            list.innerHTML = ""; 

            const groups = {};
            events.forEach(e => {
                const date = e.date || "Unknown";
                const month = date.substring(0, 7); 
                if (!groups[month]) groups[month] = [];
                groups[month].push(e);
            });

            const sortedMonths = Object.keys(groups).sort().reverse();

            sortedMonths.forEach(month => {
                const monthData = groups[month];
                const li = document.createElement('li');
                li.className = 'file-item';
                
                const parts = month.split('-');
                let mName = "Misc";
                if (parts.length > 1) {
                    try {
                        mName = new Date(month + "-01").toLocaleString('default', { month: 'long' });
                    } catch(e) {}
                }
                
                li.innerHTML = `<strong>${mName}</strong> <span style="font-size:0.8em; opacity:0.7;">(${monthData.length})</span>`;
                li.onclick = () => printLog(mName + " " + parts[0], monthData);
                list.appendChild(li);
            });
        }

        function printLog(title, events) {
            log(`Printing log for ${title}`);
            const term = document.getElementById('terminal-content');
            term.innerHTML = `<span style="color: #4daafc;">> ACCESSING ${title.toUpperCase()}...</span>`; 

            let buffer = `\n\n`;
            events.forEach(e => {
                buffer += `[${e.date}] ${e.summary}\n`;
                if (e.evidence) buffer += `   ↳ ${e.evidence.substring(0, 150)}...\n`;
                buffer += `\n`;
            });
            
            // Instant render (No typewriter delay)
            const pre = document.createElement('div');
            pre.innerText = buffer;
            term.appendChild(pre);
            
            const viewer = document.getElementById('main-terminal');
            viewer.scrollTop = viewer.scrollHeight;
        }
    </script>
</body>
</html>
