<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline | Jason Allred</title>
    <link rel="stylesheet" href="style.css?v=6.2">
</head>
<body>

    <button id="menu-toggle">☰ MENU</button>

    <nav id="sidebar">
        <h1>The Field Manual</h1>
        <div class="subtitle">Jason Allred</div>
        <div class="sys-banner">GENERATED BY PINKY (MISTRAL-7B)</div>
        <a href="index.html">← Dashboard</a>
        
        <h2>Timeline Index</h2>
        <ul id="timeline-nav"></ul>
    </nav>

    <main>
        <section>
            <h2 style="color: var(--heading-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Career Timeline</h2>
            
            <div class="timeline-container" id="tree-root">
                <div style="color: #666; padding: 20px;">[WAIT] Loading archives...</div>
            </div>

            <div class="terminal-viewer" id="main-terminal">
                <div class="terminal-header">LOG VIEWER</div>
                <div id="terminal-content" style="color: #ccc;">Select a month to query...<span class="cursor"></span></div>
            </div>
        </section>
    </main>

    <script>
        const yearCache = {};
        let typeInterval;

        // FAIL-SAFE DATA (Inlined to prevent empty screen on fetch fail)
        const FALLBACK_THEMES = {
            "2024": { "strategic_theme": "Implementing manageability features." },
            "2018": { "strategic_theme": "Hardware validation." },
            "2016": { "strategic_theme": "Fulsim debugging." },
            "2006": { "strategic_theme": "Firmware validation." }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const root = document.getElementById('tree-root');
            const nav = document.getElementById('timeline-nav');
            
            // 1. Mobile Menu
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            if (menuToggle && sidebar) {
                menuToggle.onclick = (e) => {
                    sidebar.classList.toggle('active');
                    e.stopPropagation();
                };
                document.querySelector('main').onclick = () => sidebar.classList.remove('active');
            }

            // 2. Load Data
            let fetched = false;
            fetch('data/themes.json?t=' + new Date().getTime())
                .then(r => r.json())
                .then(themes => {
                    fetched = true;
                    renderYears(themes);
                })
                .catch(() => {
                    if (!fetched) renderYears(FALLBACK_THEMES);
                });

            // 2s Timeout
            setTimeout(() => {
                if (!fetched) renderYears(FALLBACK_THEMES);
            }, 2000);

            function renderYears(themes) {
                root.innerHTML = "";
                const sortedYears = Object.keys(themes).sort((a, b) => b - a);

                sortedYears.forEach(year => {
                    const item = themes[year];
                    const desc = item.strategic_theme || "Archive active.";
                    
                    // Nav Link
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="#year-${year}">./${year}</a>`;
                    nav.appendChild(li);

                    // Tree Node
                    const yearNode = document.createElement('div');
                    yearNode.className = 'tree-year';
                    yearNode.id = `year-${year}`;
                    
                    yearNode.innerHTML = "
                        <div class=\"year-label\" onclick=\"toggleYear('\'' + year + '\'')\">
                            <span>${year}</span>
                            <span style=\"font-size: 0.8rem; opacity: 0.5;\">▼</span>
                        </div>
                        <div class=\"year-content\" id=\"content-${year}\">
                            <div class=\"strategy-block\">
                                <div class=\"strategy-title\">STRATEGIC THEME</div>
                                ${desc}
                            </div>
                            <ul class=\"file-list\" id=\"files-${year}\">
                                <li style=\"color: #555;\">Loading...</li>
                            </ul>
                        </div>
                    ";
                    root.appendChild(yearNode);
                });
            }
        });

        // Global Scope Functions
        window.toggleYear = function(year) {
            const node = document.getElementById(`year-${year}`);
            const fileList = document.getElementById(`files-${year}`);
            
            if (node.classList.contains('open')) {
                node.classList.remove('open');
                return;
            }
            node.classList.add('open');

            if (!yearCache[year]) {
                fetch(`data/${year}.json?t=${new Date().getTime()}`)
                    .then(r => r.json())
                    .then(events => {
                        yearCache[year] = events;
                        renderFileList(year, events);
                    })
                    .catch(() => {
                        fileList.innerHTML = `<li style="color: #d55;">Log Missing</li>`;
                    });
            } else {
                renderFileList(year, yearCache[year]);
            }
        };

        function renderFileList(year, events) {
            const list = document.getElementById(`files-${year}`);
            list.innerHTML = ""; 
            const groups = {};
            events.forEach(e => {
                const month = (e.date || "Unknown").substring(0, 7); 
                if (!groups[month]) groups[month] = [];
                groups[month].push(e);
            });

            const sortedMonths = Object.keys(groups).sort().reverse();

            sortedMonths.forEach(month => {
                const monthData = groups[month];
                const li = document.createElement('li');
                li.className = 'file-item';
                const parts = month.split('-');
                let mName = "Misc";
                try { mName = new Date(2000, parseInt(parts[1])-1, 1).toLocaleString('default', {month:'long'}); } catch(e){}
                
                li.innerHTML = `<strong>${mName}</strong> <span style="opacity: 0.6;">(${monthData.length})</span>`;
                li.onclick = () => printLog(mName + " " + parts[0], monthData);
                list.appendChild(li);
            });
        }

        let typeInterval;
        function printLog(title, events) {
            const term = document.getElementById('terminal-content');
            if (typeInterval) clearInterval(typeInterval);
            
            term.innerHTML = `<span style="color: #4daafc;">> ACCESSING ${title.toUpperCase()}...</span>`; 
            let buffer = `\n\n`;
            events.forEach(e => {
                buffer += `[${e.date}] ${e.summary}\n`;
                if (e.evidence) buffer += `   ↳ ${e.evidence.substring(0, 150)}...\n\n`;
            });

            let i = 0;
            typeInterval = setInterval(() => {
                term.textContent += buffer.charAt(i);
                i++;
                if (i >= buffer.length) clearInterval(typeInterval);
                document.getElementById('main-terminal').scrollTop = 99999;
            }, 2);
        }
    </script>
</body>
</html>
