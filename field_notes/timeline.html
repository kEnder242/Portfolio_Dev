<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Logs | Jason Allred</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <button id="menu-toggle">☰</button>

    <nav id="sidebar">
        <h1>System Logs</h1>
        <div class="subtitle">Root Access Granted</div>
        <a href="index.html">← /var/dashboard</a>
        
        <h2>Directory</h2>
        <ul id="timeline-nav">
            <!-- Populated by JS -->
        </ul>
    </nav>

    <main>
        <section>
            <h2 style="color: var(--accent-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">/home/jason/career_history</h2>
            
            <div class="timeline-tree" id="tree-root">
                <!-- Tree Injected Here -->
            </div>

            <div class="terminal-viewer" id="main-terminal">
                <div class="terminal-header">OUTPUT BUFFER</div>
                <div id="terminal-content">Select a log file to view contents...<span class="cursor"></span></div>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const root = document.getElementById('tree-root');
            const terminal = document.getElementById('terminal-content');
            const nav = document.getElementById('timeline-nav');
            
            // Cache for Year Data
            const yearCache = {};

            // 1. Load Skeleton
            fetch('data/themes.json')
                .then(r => r.json())
                .then(themes => {
                    const sortedYears = Object.keys(themes).sort((a, b) => b - a);

                    sortedYears.forEach(year => {
                        const item = themes[year];
                        
                        // Nav Link (Quick Jump)
                        const li = document.createElement('li');
                        li.innerHTML = `<a href="#year-${year}">./${year}</a>`;
                        nav.appendChild(li);

                        // Build Tree Node
                        const yearNode = document.createElement('div');
                        yearNode.className = 'tree-year';
                        yearNode.id = `year-${year}`;
                        
                        yearNode.innerHTML = `
                            <div class="year-label" onclick="toggleYear('${year}')">${year}</div>
                            <div class="year-content" id="content-${year}">
                                <div class="strategy-block">
                                    <div class="strategy-title">STRATEGIC_OBJECTIVE</div>
                                    ${item.strategic_theme}
                                </div>
                                <ul class="file-list" id="files-${year}">
                                    <li style="color: #555; padding-left: 20px;">Scanning...</li>
                                </ul>
                            </div>
                        `;
                        root.appendChild(yearNode);
                    });
                });

            // 2. Mobile Menu
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            if (menuToggle) {
                menuToggle.addEventListener('click', () => sidebar.classList.toggle('active'));
            }
        });

        function toggleYear(year) {
            const node = document.getElementById(`year-${year}`);
            const fileList = document.getElementById(`files-${year}`);
            const isOpen = node.classList.contains('open');

            if (isOpen) {
                node.classList.remove('open');
                return;
            }

            node.classList.add('open');

            // Fetch Data if needed
            // We use the aggregated Year JSON
            fetch(`data/${year}.json`)
                .then(r => {
                    if (!r.ok) throw new Error("404");
                    return r.json();
                })
                .then(events => {
                    renderFileList(year, events);
                })
                .catch(() => {
                    fileList.innerHTML = `<li style="color: #d00;">Error: Log Missing</li>`;
                });
        }

        function renderFileList(year, events) {
            const list = document.getElementById(`files-${year}`);
            list.innerHTML = ""; // Clear "Scanning..."

            // Group by Month
            const groups = {};
            events.forEach(e => {
                const date = e.date || "Unknown";
                const month = date.substring(0, 7); // YYYY-MM
                if (!groups[month]) groups[month] = [];
                groups[month].push(e);
            });

            // Sort reverse chrono
            const sortedMonths = Object.keys(groups).sort().reverse();

            sortedMonths.forEach(month => {
                const monthData = groups[month];
                const li = document.createElement('li');
                li.className = 'file-item';
                // Convert 2016-07 to "jul_2016.log" style
                const parts = month.split('-');
                const mName = new Date(month + "-01").toLocaleString('default', { month: 'short' }).toLowerCase();
                const fileName = `${mName}_${parts[0]}.log`;
                
                li.innerHTML = `${fileName} <span style="color: #444; margin-left: 10px;">(${monthData.length} lines)</span>`;
                li.onclick = () => printLog(fileName, monthData);
                list.appendChild(li);
            });
        }

        let typeInterval;

        function printLog(filename, events) {
            const term = document.getElementById('terminal-content');
            
            // 1. Clear previous
            if (typeInterval) clearInterval(typeInterval);
            term.textContent = ""; 

            // 2. Build Buffer
            let buffer = `> cat ${filename}\n`;
            buffer += `> # ACCESSING ARCHIVE... OK\n\n`;
            
            events.forEach(e => {
                buffer += `[${e.date}] ${e.summary.toUpperCase()}\n`;
                if (e.evidence) {
                    buffer += `   >> ${e.evidence}\n`;
                }
                buffer += `\n`;
            });
            
            buffer += `> _\n`; // End cursor

            // 3. Typewriter
            let i = 0;
            // Faster speed for "Hacker" feel
            typeInterval = setInterval(() => {
                term.textContent += buffer.charAt(i);
                i++;
                if (i >= buffer.length) clearInterval(typeInterval);
                
                // Auto scroll
                const viewer = document.getElementById('main-terminal');
                viewer.scrollTop = viewer.scrollHeight;
            }, 5); 
        }
    </script>
</body>
</html>
