<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline | Jason Allred</title>
    <link rel="stylesheet" href="style.css?v=8.0">
    <style>
        /* Debug Overlay */
        #debug-panel {
            background: #110000;
            border: 1px solid red;
            color: #ffcccc;
            font-family: monospace;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 0.75rem;
            max-height: 150px;
            overflow-y: auto;
            display: block; /* VISIBLE */
        }
        
        #tree-root {
            min-height: 50px;
            border: 1px dashed #333; /* Outline to verify container presence */
        }

        .safe-back-btn {
            display: inline-block;
            padding: 10px 15px;
            background-color: #333;
            color: #fff;
            text-decoration: none;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #555;
        }
    </style>
</head>
<body>

    <button id="menu-toggle">☰ MENU</button>

    <nav id="sidebar">
        <h1>The Field Manual</h1>
        <div class="subtitle">Jason Allred</div>
        <div class="sys-banner">GENERATED BY PINKY (MISTRAL-7B)</div>
        <a href="index.html">← Dashboard</a>
        
        <h2>Timeline Index</h2>
        <ul id="timeline-nav"></ul>
    </nav>

    <main>
        <a href="index.html" class="safe-back-btn">← Emergency Exit</a>
        
        <div id="debug-panel">DEBUGGER ONLINE...</div>

        <section>
            <h2 style="color: var(--heading-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Career Timeline</h2>
            
            <div class="timeline-container" id="tree-root">
                <div style="color: #666; padding: 20px;" id="loading-msg">[WAIT] Loading archives...</div>
            </div>

            <div class="terminal-viewer" id="main-terminal">
                <div class="terminal-header">LOG VIEWER</div>
                <div id="terminal-content" style="color: #ccc;">Select a month to view details...<span class="cursor"></span></div>
            </div>
        </section>
    </main>

    <script>
        const root = document.getElementById('tree-root');
        const dbg = document.getElementById('debug-panel');
        const yearCache = {};
        let typeInterval;

        function log(msg) {
            dbg.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            console.log(msg);
        }

        window.onerror = function(msg, url, line) {
            log(`CRITICAL JS ERROR: ${msg} line ${line}`);
        };

        const FALLBACK_THEMES = {
            "2024": { "strategic_theme": "Implementing manageability features." },
            "2018": { "strategic_theme": "Hardware validation." },
            "2016": { "strategic_theme": "Fulsim debugging." },
            "2006": { "strategic_theme": "Firmware validation." }
        };

        document.addEventListener('DOMContentLoaded', () => {
            log("DOM Loaded.");
            
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            if(menuToggle && sidebar) {
                menuToggle.onclick = (e) => {
                    sidebar.classList.toggle('active');
                    e.stopPropagation();
                };
                document.querySelector('main').onclick = () => sidebar.classList.remove('active');
            }

            log("Fetching themes.json...");
            let fetchSuccess = false;
            
            fetch('data/themes.json?t=' + new Date().getTime())
                .then(r => {
                    if(!r.ok) throw new Error("HTTP " + r.status);
                    return r.json();
                })
                .then(data => {
                    fetchSuccess = true;
                    log(`Themes loaded. Found ${Object.keys(data).length} years.`);
                    renderYears(data);
                })
                .catch(e => {
                    log(`FETCH FAILED: ${e.message}`);
                    if(!fetchSuccess) {
                        log("Activating FAIL-SAFE.");
                        renderYears(FALLBACK_THEMES);
                    }
                });

            setTimeout(() => {
                if(!fetchSuccess) {
                    log("Fetch timed out (2s). Forcing Fail-Safe.");
                    renderYears(FALLBACK_THEMES);
                }
            }, 2000);
        });

        function renderYears(themes) {
            root.innerHTML = "";
            const sortedYears = Object.keys(themes).sort((a, b) => b - a);
            
            if(sortedYears.length === 0) {
                log("WARNING: Theme list is empty!");
                return;
            }

            sortedYears.forEach(year => {
                const item = themes[year];
                const desc = typeof item === 'string' ? item : (item.strategic_theme || "Archive active.");
                
                const yearNode = document.createElement('div');
                yearNode.className = 'tree-year';
                yearNode.id = `year-${year}`;
                
                yearNode.innerHTML = "
                    <div class=\"year-label\" onclick=\"window.toggleYear('${year}')\">
                        <span>${year}</span>
                        <span style=\"font-size: 0.8rem; opacity: 0.5;\">▼</span>
                    </div>
                    <div class=\"year-content\" id=\"content-${year}\">
                        <div class=\"strategy-block\">
                            <span style=\"color: #4daafc; font-weight: bold;\">STRATEGY:</span> ${desc}
                        </div>
                        <ul class=\"file-list\" id=\"files-${year}\">
                            <li style=\"color: #555;\">Loading...</li>
                        </ul>
                    </div>
                ";
                root.appendChild(yearNode);
            });
            log("Years rendered to DOM.");
        }

        window.toggleYear = function(year) {
            log(`Click: Year ${year}`);
            const node = document.getElementById(`year-${year}`);
            
            if (node.classList.contains('open')) {
                node.classList.remove('open');
                return;
            }
            node.classList.add('open');

            if (!yearCache[year]) {
                log(`Fetching data/${year}.json...`);
                fetch(`data/${year}.json?t=${new Date().getTime()}`)
                    .then(r => r.json())
                    .then(events => {
                        yearCache[year] = events;
                        renderFileList(year, events);
                        log(`Loaded ${events.length} events for ${year}`);
                    })
                    .catch(e => {
                        log(`Error loading ${year}: ${e}`);
                        document.getElementById(`files-${year}`).innerHTML = `<li style="color: #d55;">Log Missing</li>`;
                    });
            } else {
                renderFileList(year, yearCache[year]);
            }
        };

        function renderFileList(year, events) {
            const list = document.getElementById(`files-${year}`);
            list.innerHTML = ""; 

            const groups = {};
            events.forEach(e => {
                let dateDisplay = e.date || "Unknown";
                if (dateDisplay.includes("Unknown") || dateDisplay.startsWith("1970")) {
                    dateDisplay = "LOG";
                }
                // Group logic: Month or LOG bucket?
                // Just use first 7 chars for grouping
                const month = dateDisplay.substring(0, 7); 
                if (!groups[month]) groups[month] = [];
                groups[month].push(e);
            });

            Object.keys(groups).sort().reverse().forEach(month => {
                const monthData = groups[month];
                const li = document.createElement('li');
                li.className = 'file-item';
                
                let displayName = month;
                // Parse Month Name if YYYY-MM
                if (month.match(/^\d{4}-\d{2}$/)) {
                    const parts = month.split('-');
                    try {
                        displayName = new Date(2000, parseInt(parts[1])-1, 1).toLocaleString('default', {month:'long'});
                    } catch(e) {}
                }
                
                li.innerHTML = `<strong>${displayName}</strong> <span style="opacity:0.6;">(${monthData.length})</span>`;
                
                // Inline Terminal
                const term = document.createElement('div');
                term.className = 'inline-terminal';
                li.appendChild(term);
                
                li.onclick = (e) => {
                    // Prevent bubbling if clicking terminal itself
                    if(e.target.closest('.inline-terminal')) return;
                    toggleTerminal(term, displayName + " " + month, monthData);
                };
                
                list.appendChild(li);
            });
        }

        function toggleTerminal(termElement, title, events) {
            if (termElement.style.display === 'block') {
                termElement.style.display = 'none';
                return;
            }
            if (activeInterval) clearInterval(activeInterval);

            // Close others? Optional.
            
            termElement.style.display = 'block';
            termElement.innerHTML = `<span style="color: #4daafc;">> ACCESSING ${title.toUpperCase()}...</span>`;
            
            log(`Reading ${title}`);

            let buffer = `\n\n`;
            events.forEach(e => {
                let dateDisplay = e.date;
                if (!dateDisplay || dateDisplay.includes("Unknown") || dateDisplay.startsWith("1970")) {
                    dateDisplay = "LOG";
                }
                buffer += `[${dateDisplay}] ${e.summary}\n`;
                if (e.evidence) buffer += `   ↳ ${e.evidence.substring(0, 120)}\n\n`;
            });

            let i = 0;
            activeInterval = setInterval(() => {
                termElement.append(buffer.charAt(i));
                i++;
                if (i >= buffer.length) {
                    clearInterval(activeInterval);
                    termElement.innerHTML += '<span class="cursor"></span>';
                }
            }, 2);
        }
    </script>
</body>
</html>
