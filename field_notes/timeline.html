<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline | Jason Allred</title>
    <link rel="stylesheet" href="style.css?v=9.0">
    <style>
        .safe-nav-bar { margin-bottom: 20px; }
        .safe-btn { color: #888; text-decoration: none; border: 1px solid #444; padding: 5px 10px; font-size: 0.8rem; }
    </style>
</head>
<body>

    <button id="menu-toggle">☰ MENU</button>

    <nav id="sidebar">
        <h1>The Field Manual</h1>
        <div class="subtitle">Jason Allred</div>
        <div class="sys-banner">GENERATED BY PINKY (MISTRAL-7B)</div>
        <a href="index.html">← Dashboard</a>
        
        <h2>Timeline Index</h2>
        <ul id="timeline-nav"></ul>
    </nav>

    <main>
        <div class="safe-nav-bar">
            <a href="index.html" class="safe-btn">← DASHBOARD</a>
        </div>

        <div id="sys-console">
            <div>[INIT] System bootstrap...</div>
        </div>

        <section>
            <h2 style="color: var(--heading-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">/home/jason/career_history</h2>
            
            <div class="disclaimer-box">
                <span style="color: var(--accent-color); font-weight: bold;">[DATA ORIGIN]</span> 18 years of raw engineering logs, synthesized by local AI (Mistral-7B). 
                <br><span style="color: #888; font-size: 0.8em;">Note: Automated classification may contain artifacts. Reviewing logs via the terminal interface below.</span>
                <div id="pinky-status" style="margin-top: 10px; font-size: 0.8em; color: #666; border-top: 1px solid #333; padding-top: 5px;">
                    [STATUS] Connecting to neural uplink...
                </div>
            </div>

            <div class="timeline-container" id="tree-root">
                <div style="color: #666; padding: 20px;">[WAIT] Loading archives...</div>
            </div>
        </section>
    </main>

    <script>
        const root = document.getElementById('tree-root');
        const consoleEl = document.getElementById('sys-console');
        const yearCache = {};
        let activeInterval = null;

        function log(msg, type='info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            consoleEl.appendChild(div);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        const FALLBACK_THEMES = {
            "2024": { "strategic_theme": "Implementing manageability features." },
            "2018": { "strategic_theme": "Hardware validation." },
            "2016": { "strategic_theme": "Fulsim debugging." },
            "2006": { "strategic_theme": "Firmware validation." }
        };

        document.addEventListener('DOMContentLoaded', () => {
            log("DOM Ready.");
            
            // Mobile Menu
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            if (menuToggle && sidebar) {
                menuToggle.onclick = (e) => { sidebar.classList.toggle('active'); e.stopPropagation(); };
                document.querySelector('main').onclick = () => sidebar.classList.remove('active');
            }

            // Fetch Status
            fetch('data/status.json?t=' + new Date().getTime())
                .then(r => r.json())
                .then(status => {
                    const el = document.getElementById('pinky-status');
                    let color = "#666";
                    if (status.status === "ONLINE") color = "#4cd964";
                    if (status.status === "IDLE") color = "#4daafc";
                    
                    el.innerHTML = `
                        <span style="color: ${color}; font-weight: bold;">[${status.status}]</span> 
                        ${status.message} 
                        <span style="opacity: 0.5;">(${status.timestamp})</span>
                    `;
                    log("Neural uplink connected.");
                })
                .catch(() => log("Neural uplink offline.", 'warn'));

            // Fetch Data with Fail-Safe
            let fetched = false;
            log("Mounting archives...");
            
            fetch('data/themes.json?t=' + new Date().getTime())
                .then(r => {
                    if (!r.ok) throw new Error("HTTP " + r.status);
                    return r.json();
                })
                .then(data => { 
                    fetched = true; 
                    log(`Archive mounted. Found ${Object.keys(data).length} nodes.`); 
                    renderYears(data); 
                })
                .catch(err => { 
                    log(`Mount failed (${err.message}). Using cache.`, 'err');
                    if(!fetched) renderYears(FALLBACK_THEMES); 
                });

            setTimeout(() => { 
                if(!fetched) { 
                    log("Mount timeout. Forcing local cache.", 'warn'); 
                    renderYears(FALLBACK_THEMES); 
                } 
            }, 2500);
        });

        function renderYears(themes) {
            root.innerHTML = "";
            const sortedYears = Object.keys(themes).sort((a, b) => b - a);

            if (sortedYears.length === 0) {
                root.innerHTML = "<div style='color:red'>Archive Empty.</div>";
                return;
            }

            sortedYears.forEach(year => {
                const item = themes[year];
                const desc = item.strategic_theme || "Archive active.";
                const yearNode = document.createElement('div');
                yearNode.className = 'tree-year';
                yearNode.id = `year-${year}`;
                
                yearNode.innerHTML = `
                    <div class="year-label" onclick="window.toggleYear('${year}')">
                        ${year}
                    </div>
                    <div class="year-content" id="content-${year}">
                        <div class="strategy-block">
                            <span style="color: #4daafc; font-weight: bold;">STRATEGY:</span> ${desc}
                        </div>
                        <ul class="file-list" id="files-${year}">
                            <li style="color: #555; padding-left: 20px;">Scanning...</li>
                        </ul>
                    </div>
                `;
                root.appendChild(yearNode);
            });
            log("Directory tree rendered.");
        }

        window.toggleYear = function(year) {
            log(`Expanding node: ${year}`);
            const node = document.getElementById(`year-${year}`);
            if (node.classList.contains('open')) {
                node.classList.remove('open');
                return;
            }
            node.classList.add('open');

            if (!yearCache[year]) {
                fetch(`data/${year}.json?t=${new Date().getTime()}`)
                    .then(r => r.json())
                    .then(events => {
                        yearCache[year] = events;
                        renderFileList(year, events);
                        log(`Loaded ${events.length} records.`);
                    })
                    .catch(() => {
                        log(`Error reading ${year}.json`, 'err');
                        document.getElementById(`files-${year}`).innerHTML = `<li style="color: #d55; padding-left: 20px;">Log Missing</li>`;
                    });
            } else {
                renderFileList(year, yearCache[year]);
            }
        };

        function renderFileList(year, events) {
            const list = document.getElementById(`files-${year}`);
            list.innerHTML = ""; 
            const groups = {};
            events.forEach(e => {
                let dateDisplay = e.date || "Unknown";
                if (dateDisplay.includes("Unknown") || dateDisplay.startsWith("1970")) {
                    dateDisplay = "LOG";
                }
                const month = dateDisplay.substring(0, 7); 
                if (!groups[month]) groups[month] = [];
                groups[month].push(e);
            });

            Object.keys(groups).sort().reverse().forEach(month => {
                const monthData = groups[month];
                const li = document.createElement('li');
                li.className = 'file-item';
                
                let filename = "misc.log";
                
                // Case 1: Standard YYYY-MM
                if (month.match(/^\d{4}-\d{2}$/)) {
                    const parts = month.split('-');
                    let mName = "misc";
                    try { mName = new Date(2000, parseInt(parts[1])-1, 1).toLocaleString('default', {month:'short'}).toLowerCase(); } catch(e){}
                    filename = `${mName}_${parts[0]}.log`;
                } 
                // Case 2: Known Garbage (invalid date...)
                else if (month.includes("invalid") || month.includes("Unknown")) {
                    filename = "system_dump.log";
                }
                // Case 3: Just use the key sanitized
                else {
                    filename = month.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase() + ".log";
                }

                // Inline Terminal Structure
                const row = document.createElement('div');
                row.className = 'file-row';
                row.innerHTML = `<strong>${filename}</strong> (${monthData.length})`;
                
                const term = document.createElement('div');
                term.className = 'inline-terminal';
                
                li.appendChild(row);
                li.appendChild(term);
                
                row.onclick = () => toggleTerminal(term, filename, monthData);
                list.appendChild(li);
            });
        }

        function toggleTerminal(termElement, title, events) {
            if (termElement.style.display === 'block') {
                termElement.style.display = 'none';
                return;
            }
            if (activeInterval) clearInterval(activeInterval);

            termElement.style.display = 'block';
            termElement.innerHTML = `<span style="color: #4daafc;">> ACCESSING ${title.toUpperCase()}...</span>`;
            
            log(`Reading ${title}`);

            let buffer = `\n\n`;
            events.forEach(e => {
                let dateDisplay = e.date;
                // Strict visual filter: Only show YYYY-MM-DD or simple Month
                // If it looks like garbage, hide it.
                if (!dateDisplay || !dateDisplay.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    dateDisplay = "LOG";
                }
                
                buffer += `[${dateDisplay}] ${e.summary}\n`;
                if (e.evidence) buffer += `   ↳ ${e.evidence.substring(0, 120)}\n\n`;
            });

            let i = 0;
            activeInterval = setInterval(() => {
                termElement.append(buffer.charAt(i));
                i++;
                if (i >= buffer.length) {
                    clearInterval(activeInterval);
                    termElement.innerHTML += '<span class="cursor"></span>';
                }
            }, 2);
        }
    </script>
</body>
</html>